<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="VBphenoR">
<title>Variational Bayes for Latent Patient Phenotypes in EHR • VBphenoR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Variational Bayes for Latent Patient Phenotypes in EHR">
<meta property="og:description" content="VBphenoR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">VBphenoR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/VBphenoR.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/buckleybrian/VBphenoR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Variational Bayes for Latent Patient Phenotypes in EHR</h1>
                        <h4 data-toc-skip class="author">Brian Buckley,
Adrian O’Hagan, Marie Galligan</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/buckleybrian/VBphenoR/blob/HEAD/vignettes/articles/VBphenoR.Rmd" class="external-link"><code>vignettes/articles/VBphenoR.Rmd</code></a></small>
      <div class="d-none name"><code>VBphenoR.Rmd</code></div>
    </div>

    
    
<style>
 body{
  font-size: 12pt;
 }
 h1{
  font-size: 18pt;
 }
 h2{
  font-size: 16pt;
 }
 h3{donttest
  font-size: 14pt;
 }
 p.caption {
  font-size: 0.8em;
 }
</style>
<p>This is the vignette for package VBphenoR.</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>We previously implemented a patient phenotyping latent class model,
Buckley et al. (2024) <span class="citation">[1]</span>, using automatic
differentiation variational inference (ADVI) available in the Stan <span class="citation">[2]</span> and PyMC3 <span class="citation">[3]</span>
software . Although this approach delivered reasonable results, it
required significantly complex technical tuning and multiple
trial-and-error iterations. We find automatic VB methods as implemented
in Stan VB are complex to configure and are very sensitive to model
definition and algorithm hyperparameters such as choice of gradient
optimiser.</p>
<p>We now propose a closed-form approach based on the theory defined in
Bishop (2006) <span class="citation">[4]</span>, Nakajima et al. (2019)
<span class="citation">[5]</span> and the review of Blei et al. (2017)
<span class="citation">[6]</span>. We implement a variational Bayes
Gaussian Mixture Model (GMM) algorithm using the closed-form coordinate
ascent variational inference (CAVI) approach to determine the phenotype
latent class, then implement a variational Bayes logit regression based
on Durante &amp; Rigon (2019) <span class="citation">[7]</span>, where
we determine the probability of the phenotype in the supplied cohort,
the shift in biomarkers for patients with the phenotype of interest
versus a normal population along with sensitivity analysis of binary
indicator clinical codes and medication codes. The logit model
likelihood uses the latent class from the GMM step to inform the
conditional (see section 2.2 in <span class="citation">[1]</span>).</p>
<p>The implementation of VBphenoR performs the following steps:</p>
<ol style="list-style-type: decimal">
<li>
<p>Run a variational Gaussian Mixture Model using EHR-derived
patient characteristics to discover the latent variable <span class="math inline">\(D_i\)</span> indicating the phenotype of interest
for the <span class="math inline">\(i^{th}\)</span> patient. Patient
characteristics can be any patient variables typically found in EHR data
e.g.</p>
<ul>
<li>Gender</li>
<li>Age</li>
<li>Ethnicity (for disease conditions with ethnicity-related increased
risk)</li>
<li>Physical e.g. BMI for Type 2 Diabetes</li>
<li>Clinical codes (diagnosis, observations, specialist visits,
etc.)</li>
<li>Prescription medications related to the disease condition</li>
<li>Biomarkers (usually by laboratory tests)</li>
</ul>
</li>
<li><p>Run a variational Regression model using the latent variable
<span class="math inline">\(D_i\)</span> derived in step 1 as an
interaction effect to determine the shift in biomarker levels from
baseline for patients with the phenotype versus those without.
Appropriately informative priors are used to set the biomarker
baseline.</p></li>
<li><p>Run a variational Regression model using the latent variable
derived in step 1 as an interaction effect to determine the sensitivity
and specificity of binary indicators for clinical codes, medications and
availability of biomarkers (since biomarker laboratory tests will
include a level of missingness).</p></li>
</ol>
<p>In the following example we use the Sickle Cell Disease (SCD) data
available in this package to find the rare phenotype. SCD is extremely
rare so we use DBSCAN to initialise the VB GMM. We also use an
informative prior for the mixing coefficient and stop iterations when
the ELBO starts to reverse so that we stop when the minor (SCD)
component is reached.</p>
<p><span class="math inline">\(\\\)</span></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the SCD example data supplied with the VBphenoR package</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">scd_cohort</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We will use the SCD biomarkers to discover the SCD latent class</span></span>
<span><span class="va">X1</span> <span class="op">&lt;-</span> <span class="va">scd_cohort</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">CBC</span>,<span class="va">RC</span><span class="op">)</span><span class="op">]</span></span>
<span> </span>
<span><span class="co"># We need to supply DBSCAN hyper-parameters as we will initialise VBphenoR</span></span>
<span><span class="co"># with DBSCAN. See help(DBSCAN) for details of these parameters.</span></span>
<span><span class="va">initParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">initParams</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'eps'</span>,<span class="st">'minPts'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># X1 is the data matrix for the VB GMM</span></span>
<span><span class="va">X1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X1</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Set an informative prior for the VB GMM mixing coefficient alpha </span></span>
<span><span class="co"># hyper-parameter</span></span>
<span><span class="va">prior_gmm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  alpha <span class="op">=</span> <span class="fl">0.001</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set informative priors for the beta coefficients of the VB logit</span></span>
<span><span class="va">prior_logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mu<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">scd_cohort</span><span class="op">$</span><span class="va">age</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">scd_cohort</span><span class="op">$</span><span class="va">highrisk</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">scd_cohort</span><span class="op">$</span><span class="va">CBC</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">scd_cohort</span><span class="op">$</span><span class="va">RC</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              Sigma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span>           <span class="co"># Simplest isotropic case</span></span>
<span></span>
<span><span class="co"># X2 is the design matrix for the VB logit</span></span>
<span><span class="va">X2</span> <span class="op">&lt;-</span> <span class="va">scd_cohort</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">age</span>,<span class="va">highrisk</span>,<span class="va">CBC</span>,<span class="va">RC</span><span class="op">)</span><span class="op">]</span> </span>
<span><span class="va">X2</span><span class="op">[</span>,<span class="va">age</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">X2</span><span class="op">[</span>,<span class="va">highrisk</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">highrisk</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">X2</span><span class="op">[</span>,<span class="va">Intercept</span><span class="op">:=</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setcolorder.html" class="external-link">setcolorder</a></span><span class="op">(</span><span class="va">X2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>,<span class="st">"age"</span>,<span class="st">"highrisk"</span>,<span class="st">"CBC"</span>,<span class="st">"RC"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">pheno_result</span> <span class="op">&lt;-</span> <span class="fu">runModel</span><span class="op">(</span><span class="va">scd_cohort</span>,</span>
<span>                        gmm_X<span class="op">=</span><span class="va">X1</span>, gmm_k<span class="op">=</span><span class="va">k</span>, gmm_init<span class="op">=</span><span class="st">"DBSCAN"</span>,</span>
<span>                        gmm_initParams<span class="op">=</span><span class="va">initParams</span>,</span>
<span>                        gmm_maxiters<span class="op">=</span><span class="fl">20</span>, gmm_prior<span class="op">=</span><span class="va">prior_gmm</span>,</span>
<span>                        gmm_stopIfELBOReverse<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                        logit_X<span class="op">=</span><span class="va">X2</span>, logit_prior<span class="op">=</span><span class="va">prior_logit</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Biomarker shifts for phenotype of interest</span></span>
<span><span class="va">pheno_result</span><span class="op">$</span><span class="va">biomarker_shift</span></span>
<span></span>
<span><span class="co">#   CBC_shift RC_shift</span></span>
<span><span class="co"># 1      7.93     3.67</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a>
</h2>
<div class="section level3">
<h3 id="variational-gaussian-mixture-model">Variational Gaussian Mixture Model<a class="anchor" aria-label="anchor" href="#variational-gaussian-mixture-model"></a>
</h3>
<p>We employ a variational Gaussian Mixture Model (GMM) to detect the
latent class for patients with the disease condition based on patient
characteristics. The full derivation for the GMM can be found in Bishop
(2006) <span class="citation">[4]</span>. Here, we explain how the
posterior is affected by informative priors. The derivation in Bishop
(2006) uses conjugate priors to simplify the analysis so we implement
the same conjugacy in this package.</p>
<p>The conjugate prior for the GMM mixing coefficients, <span class="math inline">\(\pi\)</span>, is a Dirichlet distribution with
prior hyperparameter <span class="math inline">\(\alpha\)</span>.</p>
<p><span class="math display">\[q(\bf{\pi}) = \textit{Dir}(
\bf{\pi}|\alpha)\]</span> The conjugate prior governing the unknown mean
and precision of each GMM multivariate Gaussian component is an
independent Gaussian-Wishart prior.</p>
<p><span class="math display">\[q(\bf{\mu}, \bf{\Lambda}) =
\mathbb{N}(\bf{\mu}|\bf{m},
(\beta\bf{\Lambda})^{-1})\mathbb{W}(\bf{\Lambda}|\bf{W},
\nu)\]</span></p>
<p>Where</p>
<ul>
<li>
<span class="math inline">\(\beta\)</span> governs the
proportionality of the precision, <span class="math inline">\(\Lambda\)</span>
</li>
<li>
<span class="math inline">\(W\)</span> is a symmetric, positive
definite matrix with dimensions given by the number of mixture
components and governs the unknown precision of each GMM multivariate
Gaussian component</li>
<li>
<span class="math inline">\(m\)</span> is a prior hyperparameter
governing the mean vector for the normal part. This is usually defaulted
to the row means of the data. A different value can be used in rare
cases where there is some specific prior clinical evidence that the
cluster means should fall in a specific region away from the data
mean.</li>
<li>
<span class="math inline">\(\nu\)</span>, the degrees of freedom,
ensures the Wishart <span class="math inline">\(\Gamma\)</span> function
is well-defined. <span class="math inline">\(\nu\)</span> must be
greater than <span class="math inline">\(D-1\)</span> (where <span class="math inline">\(D\)</span> is the dimensionality of the data) to
ensure the distribution is proper and the mean of the Wishart (<span class="math inline">\(\nu W^{-1}\)</span>) exists. This is usually
defaulted to <span class="math inline">\(D+1\)</span> as it is the
smallest value that ensures the Wishart distribution is proper and the
expected value of the precision matrix exists. This value also results
in a vague prior. It could be increased if there is a desire to avoid
overly flexible or noisy covariance estimates.</li>
</ul>
<div class="section level4">
<h4 id="effect-of-informative-priors">Effect of informative priors<a class="anchor" aria-label="anchor" href="#effect-of-informative-priors"></a>
</h4>
<p>Informative priors play an important role in the variational model.
In this section we will briefly outline the prior effects on the VB
posterior estimates. For a full explanation please see <span class="citation">[4]</span>. We use the <em>kmeans</em> “init” option
for the illustration as the <em>faithful</em> data is simple. For
complex data, such as our <em>Sickle Cell Disease</em> data, where the
disease-positive class is extremely unbalanced (0.3%) and covered by a
very noisy tail from the negative class, we use <em>DBSCAN</em>
instead.</p>
<div class="section level5">
<h5 id="prior-hyperparameter-alpha-for-the-mixing-dirichlet-distribution-">Prior hyperparameter <span class="math inline">\(\alpha\)</span> for
the mixing Dirichlet distribution.<a class="anchor" aria-label="anchor" href="#prior-hyperparameter-alpha-for-the-mixing-dirichlet-distribution-"></a>
</h5>
<p>The prior for the GMM mixing coefficients, <span class="math inline">\(\pi\)</span>, affects the expectation such that if
<span class="math inline">\(\alpha \longrightarrow 0\)</span>, then the
posterior distribution will be influenced primarily by the data and as
<span class="math inline">\(\alpha \longrightarrow \inf\)</span> then
the prior will have increased influence on the posterior.</p>
<p>To illustrate in Figure 1, we use the base R <em>faithful</em> data
with three different values for <span class="math inline">\(\alpha\)</span> (low, medium and high) and set
<span class="math inline">\(k=6\)</span>. In this simplest case, we use
the same <span class="math inline">\(\alpha\)</span> value for each
component. As alpha increases, the number of cluster components clearly
approaches the desired k. However, a lower alpha tends to produce a more
intuitive number of components for these data. In a realistic clinical
setting, prior clinical knowledge can be used to guide the selection of
alpha, allowing us to balance the number of components in a way that
provides meaningful clinical insight while minimising the risk of bias
introduced by setting alpha too high.</p>
<div class="figure" style="text-align: center">
<img src="alpha_1_271.png" alt="Figure1. Posterior clustering with three alpha prior hyperparameter settings. (a); low alpha setting, (c); high alpha setting and (b); a setting between low and high." width="30%" height="30%"><img src="alpha_30_237.png" alt="Figure1. Posterior clustering with three alpha prior hyperparameter settings. (a); low alpha setting, (c); high alpha setting and (b); a setting between low and high." width="30%" height="30%"><img src="alpha_70_202.png" alt="Figure1. Posterior clustering with three alpha prior hyperparameter settings. (a); low alpha setting, (c); high alpha setting and (b); a setting between low and high." width="30%" height="30%"><p class="caption">
Figure1. Posterior clustering with three alpha prior hyperparameter
settings. (a); low alpha setting, (c); high alpha setting and (b); a
setting between low and high.
</p>
</div>
<p>If we use different <span class="math inline">\(\alpha\)</span>
values for each cluster we can further fine-tune the resulting
posterior. In Figure 2, we illustrate three different settings where the
<span class="math inline">\(\alpha\)</span> per cluster is equal and set
low (left), equal and set high (right) and different per cluster
component (middle). In this example we set <span class="math inline">\(k=4\)</span>.</p>
<div class="figure" style="text-align: center">
<img src="alpha_1_1_1_1.png" alt="Figure 2. Posterior clustering with three different alpha vector prior hyperparameter settings. (a); equal alpha vectors, (c); different alpha vectors and (b); two equal and two different alpha vectors." width="30%" height="30%"><img src="alpha_1_92_183_183.png" alt="Figure 2. Posterior clustering with three different alpha vector prior hyperparameter settings. (a); equal alpha vectors, (c); different alpha vectors and (b); two equal and two different alpha vectors." width="30%" height="30%"><img src="alpha_183_92_183_183.png" alt="Figure 2. Posterior clustering with three different alpha vector prior hyperparameter settings. (a); equal alpha vectors, (c); different alpha vectors and (b); two equal and two different alpha vectors." width="30%" height="30%"><p class="caption">
Figure 2. Posterior clustering with three different alpha vector prior
hyperparameter settings. (a); equal alpha vectors, (c); different alpha
vectors and (b); two equal and two different alpha vectors.
</p>
</div>
<p><span class="math inline">\(\\\)</span></p>
</div>
<div class="section level5">
<h5 id="prior-hyperparameter-beta-for-pseudo-observations-for-the-gaussian-inverse-wishart-distribution-">Prior hyperparameter <span class="math inline">\(\beta\)</span> for
pseudo-observations for the Gaussian-inverse Wishart distribution.<a class="anchor" aria-label="anchor" href="#prior-hyperparameter-beta-for-pseudo-observations-for-the-gaussian-inverse-wishart-distribution-"></a>
</h5>
<p>The <span class="math inline">\(\beta\)</span> prior has a
significant effect on the posterior as shown in Figure 3. Here, we show
the effect of a very low value for <span class="math inline">\(\beta\)</span> and a very high value for <span class="math inline">\(\beta\)</span>. Low values for <span class="math inline">\(\beta\)</span> lead to weaker distributions around
<span class="math inline">\(m\)</span>. In this case the posterior
means, <span class="math inline">\(\mu_k\)</span>, will be driven mainly
by the data assigned to each cluster. On the contrary, high <span class="math inline">\(\beta\)</span> values encode a strong belief that
component means are close to <span class="math inline">\(m\)</span>.</p>
<div class="figure" style="text-align: center">
<img src="beta_0.1_0.1_0.1_0.1.png" alt="Figure 3. Posterior clustering with two different beta vector prior hyperparameter settings. (a); low beta vectors, (b); high beta vectors." width="30%" height="30%"><img src="beta_0.9_0.9_0.9_0.9.png" alt="Figure 3. Posterior clustering with two different beta vector prior hyperparameter settings. (a); low beta vectors, (b); high beta vectors." width="30%" height="30%"><p class="caption">
Figure 3. Posterior clustering with two different beta vector prior
hyperparameter settings. (a); low beta vectors, (b); high beta vectors.
</p>
</div>
<p><span class="math inline">\(\\\)</span></p>
</div>
<div class="section level5">
<h5 id="prior-hyperparameter-w-for-the-scale-matrix-for-the-inverse-wishart-">Prior hyperparameter <span class="math inline">\(W\)</span> for the
scale matrix for the inverse Wishart.<a class="anchor" aria-label="anchor" href="#prior-hyperparameter-w-for-the-scale-matrix-for-the-inverse-wishart-"></a>
</h5>
<p>The <span class="math inline">\(W\)</span> prior for the
Normal-Wishart posterior also has a significant effect on the posterior
as illustrated in Figure 4. Low values for <span class="math inline">\(W\)</span> results in more clusters that are
likely to be more compact. This risks overfitting. Higher values of
<span class="math inline">\(W\)</span> result in broad, low-precision
Gaussians. This risks underfitting.</p>
<div class="figure" style="text-align: center">
<img src="w_0.001_0.001.png" alt="Figure 4. Posterior clustering with two different W vector prior hyperparameter settings. (a); low W vectors, (b); high W vectors." width="30%" height="30%"><img src="w_2.001_2.001.png" alt="Figure 4. Posterior clustering with two different W vector prior hyperparameter settings. (a); low W vectors, (b); high W vectors." width="30%" height="30%"><p class="caption">
Figure 4. Posterior clustering with two different W vector prior
hyperparameter settings. (a); low W vectors, (b); high W vectors.
</p>
</div>
<!--
#### Prior hyperparameter $m$ for the mean vector of the Gaussian-Wishart distribution.

#### Prior hyperparameter $\nu$ governing the Wishart $\Gamma$ function of the Gaussian-Wishart distribution as it is the degrees of freedom of an inverse Wishart distribution.
-->
<p><span class="math inline">\(\\\)</span></p>
<p>The following examples were used to generate Figures 2, 3 and 4.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"faithful"</span><span class="op">)</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">faithful</span></span>
<span>  <span class="va">P</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Run with 4 presumed components for demonstration purposes</span></span>
<span>  <span class="va">k</span> <span class="op">=</span> <span class="fl">4</span></span>
<span></span>
<span>  <span class="co"># ------------------------------------------------------------------------------</span></span>
<span>  <span class="co"># Plotting</span></span>
<span>  <span class="co"># ------------------------------------------------------------------------------</span></span>
<span></span>
<span>  <span class="co">#' Plots the GMM components with centroids</span></span>
<span>  <span class="co">#'</span></span>
<span>  <span class="co">#' @param i List index to place the plot</span></span>
<span>  <span class="co">#' @param gmm_result Results from the VB GMM run</span></span>
<span>  <span class="co">#' @param var_name Variable to hold the GMM hyperparameter name</span></span>
<span>  <span class="co">#' @param grid Grid element used in the plot file name</span></span>
<span>  <span class="co">#' @param fig_path Path to the directory where the plots should be stored</span></span>
<span>  <span class="co">#'</span></span>
<span>  <span class="co">#' @returns</span></span>
<span>  <span class="co">#' @importFrom ggplot2 ggplot</span></span>
<span>  <span class="co">#' @export</span></span>
<span></span>
<span>  <span class="va">do_plots</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">gmm_result</span>, <span class="va">var_name</span>, <span class="va">grid</span>, <span class="va">fig_path</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X</span>, cluster <span class="op">=</span> <span class="va">gmm_result</span><span class="op">$</span><span class="va">z_post</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">dd</span><span class="op">$</span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">dd</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># The group means</span></span>
<span>    <span class="co"># ---------------------------------------------------------------------------</span></span>
<span>    <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">gmm_result</span><span class="op">$</span><span class="va">q_post</span><span class="op">$</span><span class="va">m</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Plot the posterior mixture groups</span></span>
<span>    <span class="co"># ---------------------------------------------------------------------------</span></span>
<span>    <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#1170AA"</span>, <span class="st">"#55AD89"</span>, <span class="st">"#EF6F6A"</span>, <span class="st">"#D3A333"</span>, <span class="st">"#5FEFE8"</span>, <span class="st">"#11F444"</span><span class="op">)</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_point</span><span class="op">(</span><span class="va">dd</span>, mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">eruptions</span>, y<span class="op">=</span><span class="va">waiting</span>, color<span class="op">=</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">scale_color_discrete</span><span class="op">(</span><span class="va">cols</span>, guide <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_point</span><span class="op">(</span><span class="va">mu</span>, mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">eruptions</span>, y <span class="op">=</span> <span class="va">waiting</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"black"</span>,</span>
<span>                 pch<span class="op">=</span><span class="fl">7</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">stat_ellipse</span><span class="op">(</span><span class="va">dd</span>, geom<span class="op">=</span><span class="st">"polygon"</span>,</span>
<span>                   mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">eruptions</span>, y<span class="op">=</span><span class="va">waiting</span>, fill<span class="op">=</span><span class="va">cluster</span><span class="op">)</span>,</span>
<span>                   alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">plots</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">gmm_result</span>, <span class="va">dd</span>, <span class="va">mu</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">grids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="op">(</span><span class="va">grid</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span>    <span class="fu">ggsave</span><span class="op">(</span>filename<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">var_name</span>,<span class="st">"_"</span>,<span class="va">grids</span>,<span class="st">".png"</span><span class="op">)</span>, plot<span class="op">=</span><span class="va">p</span>, path<span class="op">=</span><span class="va">fig_path</span>,</span>
<span>           width<span class="op">=</span><span class="fl">12</span>, height<span class="op">=</span><span class="fl">12</span>, units<span class="op">=</span><span class="st">"cm"</span>, dpi<span class="op">=</span><span class="fl">600</span>, create.dir <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># ------------------------------------------------------------------------------</span></span>
<span>  <span class="co"># Dirichlet alpha</span></span>
<span>  <span class="co"># ------------------------------------------------------------------------------</span></span>
<span>  <span class="va">alpha_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>c1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">183</span><span class="op">)</span>,</span>
<span>                           c2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">92</span>,<span class="fl">92</span><span class="op">)</span>,</span>
<span>                           c3<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">183</span>,<span class="fl">198</span><span class="op">)</span>,</span>
<span>                           c4<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">198</span>,<span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">init</span> <span class="op">&lt;-</span> <span class="st">"kmeans"</span></span>
<span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode<span class="op">=</span><span class="st">"list"</span>, length<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">alpha_grid</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode<span class="op">=</span><span class="st">"list"</span>, length<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">alpha_grid</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Just plot the first 5 grids to save time</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">alpha_grid</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">alpha_grid</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span> <span class="co"># set most of the weight on one component</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">gmm_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vb_gmm_cavi.html">vb_gmm_cavi</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">X</span>, k<span class="op">=</span><span class="va">k</span>, prior<span class="op">=</span><span class="va">prior</span>, delta<span class="op">=</span><span class="fl">1e-9</span>, init<span class="op">=</span><span class="va">init</span>,</span>
<span>                              verbose<span class="op">=</span><span class="cn">FALSE</span>, logDiagnostics<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">z</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">gmm_result</span><span class="op">$</span><span class="va">z_post</span><span class="op">)</span></span>
<span>    <span class="fu">do_plots</span><span class="op">(</span><span class="va">i</span>, <span class="va">gmm_result</span>, <span class="st">"alpha"</span>, <span class="va">alpha_grid</span>, <span class="va">gen_path</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># ------------------------------------------------------------------------------</span></span>
<span>  <span class="co"># Normal-Wishart beta for precision proportionality</span></span>
<span>  <span class="co"># ------------------------------------------------------------------------------</span></span>
<span>  <span class="va">beta_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>c1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.9</span><span class="op">)</span>,</span>
<span>                          c2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.9</span><span class="op">)</span>,</span>
<span>                          c3<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.9</span><span class="op">)</span>,</span>
<span>                          c4<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.9</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">init</span> <span class="op">&lt;-</span> <span class="st">"kmeans"</span></span>
<span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode<span class="op">=</span><span class="st">"list"</span>, length<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_grid</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode<span class="op">=</span><span class="st">"list"</span>, length<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_grid</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Just plot the first 5 grids to save time</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_grid</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">beta_grid</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">gmm_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vb_gmm_cavi.html">vb_gmm_cavi</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">X</span>, k<span class="op">=</span><span class="va">k</span>, prior<span class="op">=</span><span class="va">prior</span>, delta<span class="op">=</span><span class="fl">1e-9</span>, init<span class="op">=</span><span class="va">init</span>,</span>
<span>                              verbose<span class="op">=</span><span class="cn">FALSE</span>, logDiagnostics<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">z</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">gmm_result</span><span class="op">$</span><span class="va">z_post</span><span class="op">)</span></span>
<span>    <span class="fu">do_plots</span><span class="op">(</span><span class="va">i</span>, <span class="va">gmm_result</span>, <span class="st">"beta"</span>, <span class="va">beta_grid</span>, <span class="va">gen_path</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># ------------------------------------------------------------------------------</span></span>
<span>  <span class="co"># Normal-Wishart W0 (assuming variance matrix) &amp; logW</span></span>
<span>  <span class="co"># ------------------------------------------------------------------------------</span></span>
<span></span>
<span>  <span class="va">w_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>w1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.001</span>,<span class="fl">2.001</span><span class="op">)</span>,</span>
<span>                       w2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.001</span>,<span class="fl">2.001</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">init</span> <span class="op">&lt;-</span> <span class="st">"kmeans"</span></span>
<span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode<span class="op">=</span><span class="st">"list"</span>, length<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">w_grid</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode<span class="op">=</span><span class="st">"list"</span>, length<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">w_grid</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Just plot the first 5 grids to save time</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">w_grid</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">w0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">w_grid</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">P</span><span class="op">)</span></span>
<span>    <span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      W <span class="op">=</span> <span class="va">w0</span>,</span>
<span>      logW <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chol.html" class="external-link">chol</a></span><span class="op">(</span><span class="va">w0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">gmm_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vb_gmm_cavi.html">vb_gmm_cavi</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">X</span>, k<span class="op">=</span><span class="va">k</span>, prior<span class="op">=</span><span class="va">prior</span>, delta<span class="op">=</span><span class="fl">1e-9</span>, init<span class="op">=</span><span class="va">init</span>,</span>
<span>                              verbose<span class="op">=</span><span class="cn">FALSE</span>, logDiagnostics<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">z</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">gmm_result</span><span class="op">$</span><span class="va">z_post</span><span class="op">)</span></span>
<span>    <span class="fu">do_plots</span><span class="op">(</span><span class="va">i</span>, <span class="va">gmm_result</span>, <span class="st">"w"</span>, <span class="va">w_grid</span>, <span class="va">gen_path</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level4">
<h4 id="effect-of-initialiser">Effect of initialiser<a class="anchor" aria-label="anchor" href="#effect-of-initialiser"></a>
</h4>
<p>The VB GMM can be initialised using one of four methods:</p>
<ol style="list-style-type: decimal">
<li>kmeans</li>
<li>DBSCAN</li>
<li>Random assignment</li>
</ol>
<p><em>kmeans</em> is the default as it is simple, computationally fast
and gives reasonable estimates if the data are not too complex In cases
of complex data, such as the Sickle Cell Disease sample data included in
the package, we recommend <em>DBSCAN</em>. The <em>Random
assignment</em> option is rarely useful but is included for
completeness. If there are more components in the result than you
require we recommend <em>HDBSCAN</em> to merge unwanted clusters. <span class="math inline">\(\\\)</span></p>
<div class="section level5">
<h5 id="vb-gmm-example-using-kmeans">VB GMM example using kmeans<a class="anchor" aria-label="anchor" href="#vb-gmm-example-using-kmeans"></a>
</h5>
<p>Figure 5 illustrates the challenges when using <em>kmeans</em> as an
initialiser for an extremely unbalanced data set, e.g. the
<em>scd_cohort</em> data included in this package. <em>kmeans</em> is a
good option where data is not overly unbalanced as it is very
computationally fast. But it is unable to cope with very noisy and
highly unbalanced cluster classes.</p>
<div class="figure" style="text-align: center">
<img src="gmm-k2-clusters.png" alt="Figure 5: Posterior clustering of SCD Cohort using *kmeans* as initialiser.  With k=2 (a) the model cannot distinguish the rare SCD cluster from the majority class. With k=3 (b), the model is starting to find the SCD cluster but there is still too much overlap so the cluster centroid is far from the true SCD cluster. We have to go all the way to k=10 (c) before the SCD cluster is identified." width="30%" height="60%"><img src="gmm-k3-clusters.png" alt="Figure 5: Posterior clustering of SCD Cohort using *kmeans* as initialiser.  With k=2 (a) the model cannot distinguish the rare SCD cluster from the majority class. With k=3 (b), the model is starting to find the SCD cluster but there is still too much overlap so the cluster centroid is far from the true SCD cluster. We have to go all the way to k=10 (c) before the SCD cluster is identified." width="30%" height="60%"><img src="gmm-k10-clusters.png" alt="Figure 5: Posterior clustering of SCD Cohort using *kmeans* as initialiser.  With k=2 (a) the model cannot distinguish the rare SCD cluster from the majority class. With k=3 (b), the model is starting to find the SCD cluster but there is still too much overlap so the cluster centroid is far from the true SCD cluster. We have to go all the way to k=10 (c) before the SCD cluster is identified." width="30%" height="60%"><p class="caption">
Figure 5: Posterior clustering of SCD Cohort using <em>kmeans</em> as
initialiser. With k=2 (a) the model cannot distinguish the rare SCD
cluster from the majority class. With k=3 (b), the model is starting to
find the SCD cluster but there is still too much overlap so the cluster
centroid is far from the true SCD cluster. We have to go all the way to
k=10 (c) before the SCD cluster is identified.
</p>
</div>
<p><span class="math inline">\(\\\)</span></p>
</div>
<div class="section level5">
<h5 id="vb-gmm-example-using-dbscan">VB GMM example using DBSCAN<a class="anchor" aria-label="anchor" href="#vb-gmm-example-using-dbscan"></a>
</h5>
<p>Figure 6 is a single run using <em>DBSCAN</em> as the initialiser for
the highly unbalanced and noisy <em>scd_cohort</em> data.
<em>DBSCAN</em> is very capable of finding the rare phenotype class and
thus provides excellent starting positions for the VB GMM. This is at
the cost of computational performance. While <em>kmeans</em> runs in
less than a second, <em>DBSCAN</em> takes about 16 seconds for these
data. Another issue with <em>DBSCAN</em> is that it cannot be limited to
a specified number of clusters so it often returns more than k clusters
when k is small e.g. k = 2 in our current phenotyping model. We
therefore need to merge clusters returned by DBSCAN before passing the
correct number k cluster centroids to VB GMM.</p>
<div class="figure" style="text-align: center">
<img src="gmm_dbscan_k_2.jpg" alt="Figure 6: Posterior clustering of SCD Cohort using *DBSCAN* as initialiser using k=2. The SCD cluster is found by the model, albeit with some misclassified non-SCD observations on the boundary with the majority class." width="90%" height="30%"><p class="caption">
Figure 6: Posterior clustering of SCD Cohort using <em>DBSCAN</em> as
initialiser using k=2. The SCD cluster is found by the model, albeit
with some misclassified non-SCD observations on the boundary with the
majority class.
</p>
</div>
<p>Example R code to run all examples above can be found in the manual
page for <em>vb_gmm_cavi</em> and <em>VBphenoR</em>.</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="variational-logit">Variational Logit<a class="anchor" aria-label="anchor" href="#variational-logit"></a>
</h3>
<p>We employ a variational logit regression to classify the patients
with the disease condition, given the latent class we obtained from the
VB GMM. In canonical logistic regression, the response variable <span class="math inline">\(y_i\)</span> is binary and the likelihood for
<span class="math inline">\(y_i\)</span> is</p>
<p><span class="math display">\[ P(y_i|X_i,\beta) =
\sigma(X^T_i\beta)^{y_i} \cdot  [1 -
\sigma(X^T_i\beta)]^{1-y_i}\]</span> where:</p>
<ul>
<li>
<span class="math inline">\(X_i\)</span> is the feature vector for
observation <span class="math inline">\(i\)</span>,</li>
<li>
<span class="math inline">\(\beta\)</span> is the vector of
coefficients,</li>
<li>
<span class="math inline">\(\sigma(z) = \frac{1}{1 +
e^{-z}}\)</span> is the logistic i.e. sigmoid function.</li>
</ul>
<div class="section level4">
<h4 id="effect-of-informative-priors-1">Effect of informative priors<a class="anchor" aria-label="anchor" href="#effect-of-informative-priors-1"></a>
</h4>
<p>To perform Bayesian Inference, we specify a prior distribution for
the coefficients <span class="math inline">\(\beta\)</span>. A common
choice is a multivariate normal prior for the true posterior:</p>
<p><span class="math display">\[P(\beta) = \mathbb{N}(\beta|m_0,
S_0)\]</span> where:</p>
<ul>
<li>
<span class="math inline">\(m_0\)</span> is the prior mean vector
assumption for the true (unknown) mean vector,</li>
<li>
<span class="math inline">\(S_0\)</span> is the prior coveriance
matrix for the true (unknown) covariance matrix.</li>
</ul>
<p>In variational Inference, the prior is part of the Kullback-Leibler
divergence <span class="citation">[6]</span> between the approximate
posterior <span class="math inline">\(Q(\beta)\)</span> and the true
posterior <span class="math inline">\(P(\beta)\)</span>:</p>
<p><span class="math display">\[KL(Q(\beta) || P(\beta))\]</span>
where:</p>
<p><span class="math display">\[Q(\beta) =
\mathbb{N}(\beta|m,S)\]</span> and,</p>
<ul>
<li>
<span class="math inline">\(m\)</span> is the best-fit approximate
mean vector,</li>
<li>
<span class="math inline">\(S\)</span> is the best-fit approximate
covariance matrix</li>
</ul>
<p>This effect is used for optimising the variational parameters by
maximising the Evidence Lower Bound (ELBO) <span class="citation">[6]</span>, which is a lower bound on the log marginal
likelihood:</p>
<p><span class="math display">\[ELBO = \mathbb{E}_{Q(\beta)}[log
P(y|X,\beta)] - KL(Q(\beta)||P(\beta))\]</span> If we use uninformative
priors for <span class="math inline">\(m_0\)</span> and <span class="math inline">\(S_0\)</span>, we reduce the model to essentially
maximum likelihood given the data. In clinical settings, we usually have
expert medical opinion or empirical evidence that can be used to set
informative priors. This approach can enhance the clinical value of the
posterior results and overcome some of the limitations in EHR data, such
as missing biomarker data and high levels of imbalance in the response.
<span class="math inline">\(\\\)</span><span class="math inline">\(\\\)</span></p>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body">
<div id="ref-buckley2024variational" class="csl-entry">
<div class="csl-left-margin">[1] </div>
<div class="csl-right-inline">
<span class="smallcaps">Buckley</span>, B.,
<span class="smallcaps">O’Hagan</span>, A. and <span class="smallcaps">Galligan</span>, M. (2024). <span>V</span>ariational
<span>B</span>ayes latent class analysis for <span>EHR</span>-based
phenotyping with large real-world data. <em>Frontiers in Applied
Mathematics and Statistics</em> <strong>10</strong> 1302825.</div>
</div>
<div id="ref-carpenter2017stan" class="csl-entry">
<div class="csl-left-margin">[2] </div>
<div class="csl-right-inline">
<span class="smallcaps">Carpenter</span>, B.,
<span class="smallcaps">Gelman</span>, A., <span class="smallcaps">Hoffman</span>, M. D., <span class="smallcaps">Lee</span>, D., <span class="smallcaps">Goodrich</span>, B., <span class="smallcaps">Betancourt</span>, M., <span class="smallcaps">Brubaker</span>, M., <span class="smallcaps">Guo</span>, J., <span class="smallcaps">Li</span>, P.
and <span class="smallcaps">Riddell</span>, A. (2017).
<span>S</span>tan: A probabilistic programming language. <em>Journal of
<span>S</span>tatistical <span>S</span>oftware</em>
<strong>76</strong>.</div>
</div>
<div id="ref-salvatier2016probabilistic" class="csl-entry">
<div class="csl-left-margin">[3] </div>
<div class="csl-right-inline">
<span class="smallcaps">Salvatier</span>, J.,
<span class="smallcaps">Wiecki</span>, T. V. and <span class="smallcaps">Fonnesbeck</span>, C. (2016). Probabilistic
programming in <span>P</span>ython using PyMC3. <em>PeerJ Computer
Science</em> <strong>2</strong> p55.</div>
</div>
<div id="ref-bishop2006pattern" class="csl-entry">
<div class="csl-left-margin">[4] </div>
<div class="csl-right-inline">
<span class="smallcaps">Bishop</span>, C. M.
and <span class="smallcaps">Nasrabadi</span>, N. M. (2006). <em>Pattern
<span>R</span>ecognition and <span>M</span>achine
<span>L</span>earning</em>. vol 4 Springer.</div>
</div>
<div id="ref-nakajima2019variational" class="csl-entry">
<div class="csl-left-margin">[5] </div>
<div class="csl-right-inline">
<span class="smallcaps">Nakajima</span>, S.,
<span class="smallcaps">Watanabe</span>, K. and <span class="smallcaps">Sugiyama</span>, M. (2019).
<em><span>V</span>ariational <span>B</span>ayesian <span>L</span>earning
<span>T</span>heory</em>. Cambridge University Press.</div>
</div>
<div id="ref-blei2017variational" class="csl-entry">
<div class="csl-left-margin">[6] </div>
<div class="csl-right-inline">
<span class="smallcaps">Blei</span>, D. M.,
<span class="smallcaps">Kucukelbir</span>, A. and <span class="smallcaps">McAuliffe</span>, J. D. (2017). Variational inference:
A review for statisticians. <em>Journal of the American statistical
Association</em> <strong>112</strong> 859–77.</div>
</div>
<div id="ref-durante2019conditionally" class="csl-entry">
<div class="csl-left-margin">[7] </div>
<div class="csl-right-inline">
<span class="smallcaps">Durante</span>, D. and
<span class="smallcaps">Rigon</span>, T. (2019). Conditionally conjugate
mean-field variational <span>B</span>ayes for logistic models.
<em>Statistical Science</em> <strong>34</strong> 472–85.</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Brian Buckley, Adrian O’Hagan, Marie Galligan.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
